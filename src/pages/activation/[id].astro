---
import BorderedLayout from "@/layouts/BorderedLayout.astro";
import { Logo } from "@/components/Logo";
import { Navbar } from "@/components/Navbar";
import { Button } from "@/components/ui/button";
import Footer from "@/components/Footer.astro";
import { Badge } from "@/components/ui/badge";
import { GET } from "@/pages/api/get-payment/[id].ts";
import { payments } from "db/schema";
import { renderSVG } from "uqr";
import { CopyIcon } from "lucide-react";
import { formatDistanceToNow } from "date-fns";

const { pathname } = Astro.url;
export const prerender = false;

const paymentReq = GET(Astro);
const payment = (await (
  await paymentReq
).json()) as typeof payments.$inferSelect;

const qrCode = renderSVG(payment.paymentInfo.pay_address, {
  blackColor: "#554289",
});
console.log(payment.paymentInfo);
---

<title>Marz | Activation & Checkout</title>
<BorderedLayout>
  <div class="px-6 flex gap-2 items-center border-b p-5 backdrop-blur-lg">
    <Logo />
    <Navbar currentPathname={pathname} />
    <a href="/#pricing" class="hidden md:flex">
      <Button>Get Started</Button>
    </a>
  </div>

  <main>
    <div class="w-full px-4 py-8 md:p-14">
      <div class="flex flex-col md:items-center justify-center gap-2">
        <h2
          class="text-2xl md:text-4xl font-medium md:text-center text-balance pb-1"
        >
          Activation & Checkout
        </h2>
        <p
          class="text-muted-foreground md:text-center md:text-balance md:max-w-3xl"
        >
          Boost your users experience by integrating Marz into your VPN service.
        </p>
      </div>
    </div>
    <div class="flex items-center justify-center pb-20 border-t pt-5 md:pt-10">
      <div class="md:max-w-xl flex flex-col w-full gap-4 px-5">
        <p class="flex gap-1 items-center justify-between w-full">
          <span>
            Invoice ID: <Badge variant="outline">{payment.uuid}</Badge>
          </span>
          <Badge variant="outline" className="capitalize"
            >{payment.paymentStatus}</Badge
          >
        </p>
        <div class="flex gap-2">
          <div class="relative flex items-center justify-center">
            <div
              set:html={qrCode}
              class="[&>svg]:border-2 [&>svg]:border-primary [&>svg]:size-60"
            />
            <img
              src={`https://nowpayments.io/images/coins/${payment.paymentInfo.pay_currency}.svg`}
              class="size-14 absolute bg-white p-1"
            />
          </div>
          <div class="flex gap-2 flex-col overflow-hidden">
            <span class="text-sm flex flex-col">
              <span class="text-xs">Amount</span>
              <div class="flex justify-between gap-2">
                <span class="font-mono flex items-center gap-2"
                  >{payment.paymentInfo.pay_amount}
                  <Button variant="outline" size="icon-sm" className="size-6!">
                    <CopyIcon className="size-4!" />
                  </Button>
                </span>
                <span class="font-mono"
                  >~{payment.paymentInfo.price_amount}$</span
                >
              </div>
            </span>
            <div class="flex flex-col">
              <span class="text-xs">Address</span>
              <div class="font-mono text-sm flex gap-2">
                <span class="wrap-anywhere">
                  {payment.paymentInfo.pay_address}
                </span>
                <Button variant="outline" size="icon-sm" className="size-6!">
                  <CopyIcon className="size-4!" />
                </Button>
              </div>
            </div>
            <div class="flex flex-col">
              <span class="text-xs">Network</span>
              <div class="font-mono text-sm flex gap-2">
                <span class="wrap-anywhere uppercase">
                  {payment.paymentInfo.network}
                </span>
              </div>
            </div>
            <div class="flex flex-col">
              <span class="text-xs">Expiation</span>
              <div class="font-mono text-sm flex gap-2">
                <span class="wrap-anywhere uppercase">
                  {
                    formatDistanceToNow(
                      new Date(payment.paymentInfo.expiration_estimate_date)
                    )
                  }
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BorderedLayout>
